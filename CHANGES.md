# Changes (for v2.1)
This is a list of any changes done to Mary's Magical Adventure since the last release. They will be included in the list of changes for the release when it happens.
## Bug-fixes
* It's unknown if this fixed anything, but now springs lock the player twice across two tics. This is in an attempt to fix a bug where the lock would immediately get removed due to the player being on-ground right as it's set.
* Xane Corp.'s glitched line portals are now fixed by ungrouping sectors.
* Added requirement for raindrops to be in the air for three tics before being able to play "splash" sounds. This fixes hearing rain sounds through the right wall around the first corner of the PWPD HQ hallway.
* Springs now allow movement if Mary starts gliding with her umbrella. Yep, before now, since the spring lock was added, Mary's umbrella was useless if springs were involved.
* Fixed oddity where Boost Panels would accelerate players to insane speeds if they left the ground! This was caused by the "pushvels" array having only two indices instead of **three.** Arrays counting from zero can be confusing...
* When the Drop Dash was removed, a script was deleted that allowed Xane's Claw to function. As of now, the claw works again (and also works with Mary now!).
* Due to odd behavior on the new World Map, the bug where non-standard levels like the World Map and "small hut" updated your level array indices despite being programmed not to was fixed! The reason for this bug? Using an "OR" (||) instead of "AND" (&&) in the "if" conditions list. This is also why the Small Hut's teleporter couldn't detect which level the player came from, though that particular workaround isn't removed yet.
* Attempted to (but failed to) fix the screen briefly flickering to the level for a split second before the title card. I don't know if I'm ever going to truly fix this weird behavior.
* Level variable and warping behavior has been changed. Before, level[1] (current level) always updated, and was used when forcing a level to load/completing a level. Now, both array indices aren't updated on non-standard levels. Level loading (using ExitTransition and the fake "loading" screen) now warps based on what level's shown on the title card rather than the level array, though that doesn't matter because any time when the player is warped to a non-campaign level, it's always done with specifically-written scripts.
* Fixed level number becoming 0 on the world map. It's unknown why the game thinks that map is #0 (1-1) and not #999 (non-standard) despite it being defined in MAPINFO, but this was fixed by manually checking for the WORLDMAP level. GZDoom being strange as usual here.
* Fixed small hut (eventually the lab) not fading in, which was due to it being "levelnum 999" (which means it isn't a standard-numbered level), which stops the script responsible for screen-fading because the levelnum is over 200. An exception for 999 was added.
* If you tried to transform with Chaos Bridges visible (xane_showcgems set to 1), you may have noticed that there were only six of them orbiting over your head. Where was the seventh one? Well, the Special Stage's clock pickup movement script was always running, so it intercepted and moved the blue Chaos Bridge to the origin of the current level. That script is now disabled outside of Special Stages (a weird oversight), so all seven now appear properly.
* Improved precipitation framerate. Before now, rain could grind the game to nearly a halt if the player went high enugh into the air during a storm. This is because precipitation continuously spawns around the player, no matter how far each wave of raindrops would have to fall to hit the ground. This predictably destroyed the game's framerate, creating way too many raindrops. Now, raindrops, snowflakes, and cherry blossom petals are removed if they don't hit the ground within a certain number of tics.
## Major
* Checkpoints no longer store much information, now just storing the current music and the respawn point thing ID. Additionally, that thing ID is only used if the player can't be warped to their "last safe position", which was previously only used when warping back from the Small Hut or Special Stage.
* Level start points are no longer scripted warps; Before this version, your character would spawn in a small black room before being warped to where they start the level. This could fail, leading to the infamous "Black Room Glitch". Now, if nothing happens, the player will always appear at the beginning of the level, as intended. This also allows levels to have multiple starting points naturally, like when transitioning to and from the planned hub area, which will connect directly to the first level. Xane's special level starting point (TID 1995) will still use the old method, but it's so rarely used in the game's levels.
* Changed how rain sounds are generated. Now, every raindrop plays about a second of rain sound, chosen randomly from 18 sounds. This creates a more 3D sound and makes the rain more believable. Also, it improves how rain sounds when indoors near a door that leads out. It does cause sound glitches due to using a lot of "slots".
* Removed "auto wind" since I can't think of any real good use of it. As a result, wind only now moves in directions scripted during levels and is used more for currents more than wind.
* Also removed arbitrary disabling of movememnt when gliding using Mary's umbrella in higher wind speeds. The wind alone makes it hard to move against while gliding, so this artificial limitation isn't necessary.
* Xane's multiple flaps now have an "automatic" mode. Hold the jump button anytime in the air and Xane will automatically flap at an optimal rate until it's released. This will save your fingers from possibly hurting if you play this game a lot.
* A new status bar is (being) added, replacing the old one. The new status bar uses bigger meters that have the game's visual style.
* Armor was added! The power meter previously used armor internally, but now it uses its own inventory item. Currently, there aren't any armor pickups or purchasable protection, but that may change in the future, though it isn't top priority.
* Trees are now very different than before. Previously, they were single images that didn't blend in, but currently use a combination of 2D images (for leaves) and a voxel model under it all. The leaves are randomly placed within areas, giving each tree its own appearance and also allowing you to damage the tree and its leaves.
* Though not used in any official levels yet, two new 3D skyboxes were created, one for the "Asian area" level and the other for the Cumulus Peaks sky level. They're a definite upgrade from the rather static "scrolling clouds" backgrounds used in other levels. These won't replace the sky in levels that already use the 3D Skybox trick for other things, though. For example, Rolling Albatross takes place on an airship, so it uses the skybox to make it look like it's flying over a part of the city. In cases like that, the sky will stay as the basic Doom-esque sky image.
* Added a "gobal shadow" system for compatible objects (currently just the first tree). If enabled thruogh ACS on a level, objects will appear to cast shadows onto the flat surface they're on.This can be seen in the new skybox.
* Mary now has more "momentum" to her running! Before, running was basically instant, but now she starts slow and reaches full speed within a second. This adds a bit more "weight" to Mary. She can still Air Dash to reach full speed instantly. This also affects her walking, which is now slower than before due to how this "acceleration" was programmed. Xane still accelerates near-instantly, though.
* A new type of "special stage" was being experimented with, based on Hungry Puppy 3D by IndiaGames (old mobile game). It won't actually become a new Special Stage type as it isn't as fun as the "old SRB2" one that's currently in the game, but it may become a minigame.
## Minor
* In 1-3, the beach area was removed, and the bridge that comes from 1-2 is now visible from the windows of the original intro building.
* Added a "detection" mechanic to PWPD HQ. Upon entering, H-Computer alerts everyone to your presence, then warns about detectors scanning your character. Little black areas with red lasers firing from them are in some hallways, and if you don't jump over the laser, you'll be "scanned". This causes the lights to go out, alarms begin sounding, and bars lower to prevent exiting the building (though it's still possible to exit). Enemies will always be aware of your presence once this happens, always being alerted.
* Rain ambience no longer uses a separate low frequency and high frequency version of the sounds. Instead, the low frequency plays around the player as before while *normal* frequency sounds play around the player, as stated abvoe.
* Ambience script was updated to use the ambient sound object (TID 1080 + player number) that the low-frequency rain and thunder sounds use.
* The ambience script uses a much easier to edit system than before, now not a linear list of sounds.
* Corrected internal order of coins in the "AddCPowerupTics" ACS script.
* Dropped coins play more realistic sounds upon hitting the ground, with longer "ching" sounds if hitting it quickly. Also, dropped coins have height variation now, so coins will look more unique and less like clones now.
* A new song was added (#15), which plays in Special Stages, replacing #14, "The Peaceful Dimension", which is no longer in the game.
* Special Stages now require collecting large magic stars instead of ordinary coins.
* The "endless Special Stage" event flag (array index [3]) was added, which will be used before the final boss eventually. When finished, this will lock the player into the Special Stage chain until all seven are completed.
* Large magic stars collectable in Special Stages can now be picked up and can be used to complete the Special Stage without problems.
* Lights were added to City Street Run's bowling alley vent to be consistent with Peacewater Prison (Xane's section)'s vents.
* Leaves drop from trees when it's raining or an air current is flowing through the current area. As for autumn and cherry blossom trees, their leaves/petals fall constantly, regardless of wind and rain.
* Support for different foliage colors per level has been implemented. Currently, tree leaf clusters distant "imposter" tree renders change color accordingly, but leaves that fall off are still all green.
* Menu sounds were changed (again). I just can't decide how things should sound in this game!
* Juice inside of half-drank juice cylinders now can go stale if not drank again within a short time period. If it goes stale, the remaining juice in he container is forcibly removed from your inventory. This may be increased in the future. As switching levels instantly makes the juice stale, a proper global array may be used in the future to more accurately handle juice freshness.
* Proximity mines now are tinted slightly orange around the mini-thrusters at each corner, a bit of fake lighting.
* Added light pink fade in (12) and out (13). Use SetFadeOut script to see them, though they will be used for the World Map.
* Implemented sunset and sunrise appearances for the "Asian area" 3D skybox.
* Added Z offset for moving skyboxes. Argument #4 (Args[3]) controls that, while #2 and #3 ([1] and [2]) handle X and Y.
* Added draw distance support to "Welcome to Peacewater!". Additionally, the prison area was split into its own level (AREA1_X).
* Removed the ugly shading on textures in the materials mod, which turned ugly and unfittingly "realistic" in appearance when viewed from certain angles, including being nearly parallel with walls, or on floors when facing south-east.
* Bloom now better resembles its older look, with exagerated glows on anything vaguely bright. Don't worry, it isn't as overdone, and this new bloom may strike a nice balance between how it was and what GZDoom's developers turned it into. There are times where it will go overboard briefly, so if colors go overly vibrant, move or look around and that should go away.
* Hitting the ground affects your speed now! Land from a height that causes a landing sound and you'll become slightly slower for less than a second, but fall from higher heights to become even slower! Remember to carefully land by using Mary's umbrella or Xane's flight as you get near the ground for a smooth landing. Otherwise, you'll hurt Mary's feet and legs! (No falling damage, though.)
* Grass feels more "alive" and responsive. Walk near a grass patch and you'll step on it, popping back up once you're not on it anymore.
* Magic stars in Special Stages make "ding" sounds when picked up, which go along with Dashin' for Magic's current chord. (Or at least, it's supposed to, but merely pausing the game or just getting unlucky and having the game lag when loading a new sound are enough to throw it completely out of sync! (Set snd_dingchord to 0 to instead play random notes.)
* The world map now forces high draw distance on, as it's a part of its overall look.
* The world map camera now starts zoomed in on Mary before unzooming to its normal position. It's planned to have this happen in reverse upon selecting a level.
* The Windows executable, PK3/IPK3 files, and the maps WAD file have been renamed to reflect the game's new name.
* Fire has had its appearance improved! (At least, the ones produced by Mary's fireballs.) They now use particles with a nice cone shape instead of a "particle-fountain"-esque rising particles with an orb below them. These automatically lower in quality if too many are being rendered nearby.
* Cherry blossom petals (sakura) can now appear in trees! These aren't recolored, unlike the leaves, and even cause trees to continuously drop petals!
* Mary's fireball was upgraded. Though her fireball now doesn't produce near as many fires as it did in v1.95, the four fires it creates have good spread and damage things farther from the visible fires than you'd expect. Also, the fireball's direct contact explosion had its damage increased to 50, explosion radius to 32 units, and it also moves quicker now.
* Three 2D skybox renders were added. Two of them are the "asian sky" seen on the TEST level (ASIASKY1 and ASIASKY2), while the third can actually be seen in gameplay. Disable moving skyboxes by setting ***le_skyboxoff*** to 1 and load AREA4 (1-4) and you'll see a pre-rendered, still version of the city sky. Since it's only six images, it should really speed up rendering.